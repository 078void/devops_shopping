# Shopping.Client CI/CD Pipeline
# 功能：建置、推送 Docker Image、部署到 AKS

name: Shopping.Client CI/CD

# 觸發條件
on:
  push:
    branches:
      - master
      - cicd-test
    paths:
      - 'shopping/Shopping.Client/**'
      - 'shopping/k8s/shoppingclient-*.yaml'
      - '.github/workflows/shoppingclient-cicd.yml'
  
  workflow_dispatch:

# 環境變數
env:
  IMAGE_NAME: shoppingclient
  IMAGE_TAG: ${{ github.sha }}
  PROJECT_PATH: shopping/Shopping.Client
  K8S_PATH: shopping/k8s

jobs:
  # Job 1: 建置專案
  build:
    name: 建置專案
    runs-on: ubuntu-latest
    
    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v4
      
      - name: 設定 .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: 還原套件
        run: dotnet restore ${{ env.PROJECT_PATH }}
      
      - name: 建置專案
        run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

  # Job 2: 建置並推送 Docker Image
  build-and-push-image:
    name: 建置並推送 Docker Image
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v4
      
      - name: 登入 Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: 建置並推送 Docker Image
        run: |
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest \
            ${{ env.PROJECT_PATH }}
          
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

  # Job 3: 部署到 AKS
  deploy-to-aks:
    name: 部署到 AKS
    runs-on: ubuntu-latest
    needs: build-and-push-image
    
    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v4
      
      - name: 登入 Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: 設定 AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}
      
      - name: 更新 Deployment
        run: |
          kubectl apply -f ${{ env.K8S_PATH }}/shoppingclient-deployment.yaml
          kubectl apply -f ${{ env.K8S_PATH }}/shoppingclient-service.yaml
          
          kubectl set image deployment/shoppingclient-deployment \
            shoppingclient=${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          
          kubectl rollout status deployment/shoppingclient-deployment --timeout=5m
      
      - name: 取得 External IP
        run: |
          echo "等待 External IP 分配..."
          sleep 30
          EXTERNAL_IP=$(kubectl get service shoppingclient-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
          echo "應用程式 URL: http://$EXTERNAL_IP"
      
      - name: 驗證部署
        run: |
          echo "========================================="
          echo "部署完成"
          echo "========================================="
          kubectl get pods -l app=shoppingclient
          kubectl get deployment shoppingclient-deployment
          kubectl get service shoppingclient-service