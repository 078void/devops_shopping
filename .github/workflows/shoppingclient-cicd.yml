# Shopping.Client CI/CD Pipeline
# åŠŸèƒ½ï¼šå»ºç½®ã€æ¨é€ Docker Imageã€éƒ¨ç½²åˆ° AKS

name: Shopping.Client CI/CD

# è§¸ç™¼æ¢ä»¶
on:
  push:
    branches:
      - master
      - github-action-cicd-test
      - dns-setting
    paths:
      - 'shopping/Shopping.Client/**'
      - 'shopping/k8s/shoppingclient-*.yaml'
      - '.github/workflows/shoppingclient-cicd.yml'
  
  workflow_dispatch:

# ç’°å¢ƒè®Šæ•¸
env:
  IMAGE_NAME: shoppingclient
  IMAGE_TAG: ${{ github.sha }}
  PROJECT_PATH: shopping/Shopping.Client
  K8S_PATH: shopping/k8s

jobs:
  # Job 1: å»ºç½®å°ˆæ¡ˆ
  build:
    name: å»ºç½®å°ˆæ¡ˆ
    runs-on: ubuntu-latest
    
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­å®š .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
      
      - name: é‚„åŸå¥—ä»¶
        run: dotnet restore ${{ env.PROJECT_PATH }}
      
      - name: å»ºç½®å°ˆæ¡ˆ
        run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

  # Job 2: å»ºç½®ä¸¦æ¨é€ Docker Image
  build-and-push-image:
    name: å»ºç½®ä¸¦æ¨é€ Docker Image
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: ç™»å…¥ Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      
      - name: å»ºç½®ä¸¦æ¨é€ Docker Image
        run: |
          docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            -t ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest \
            ${{ env.PROJECT_PATH }}
          
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:latest

  # Job 3: éƒ¨ç½²åˆ° AKS
  deploy-to-aks:
    name: éƒ¨ç½²åˆ° AKS
    runs-on: ubuntu-latest
    needs: build-and-push-image
    
    steps:
      - name: æª¢å‡ºç¨‹å¼ç¢¼
        uses: actions/checkout@v4
      
      - name: ç™»å…¥ Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: è¨­å®š AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: ${{ secrets.AKS_RESOURCE_GROUP }}
          cluster-name: ${{ secrets.AKS_CLUSTER_NAME }}
      
      - name: æ›´æ–° Deployment
        run: |
          kubectl apply -f ${{ env.K8S_PATH }}/dataprotection-pvc.yaml

          kubectl apply -f ${{ env.K8S_PATH }}/ingress.yaml

          kubectl apply -f ${{ env.K8S_PATH }}/shoppingclient-deployment.yaml
          kubectl apply -f ${{ env.K8S_PATH }}/shoppingclient-service.yaml
          
          kubectl set image deployment/shoppingclient-deployment \
            shoppingclient=${{ secrets.ACR_LOGIN_SERVER }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          
          kubectl rollout status deployment/shoppingclient-deployment --timeout=5m
      
      - name: é¡¯ç¤ºç¶²åŸŸè³‡è¨Š
        run: |
          INGRESS_IP=$(kubectl get ingress shopping-ingress -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "Ingress å°šæœªå»ºç«‹")
          echo "========================================="
          echo "ğŸŒ ç¶²åŸŸè¨­å®šè³‡è¨Š"
          echo "========================================="
          echo "Ingress IP: $INGRESS_IP"
          echo ""
          echo "è«‹ç¢ºèª DNS è¨­å®šï¼š"
          echo "  shopping.voidspace.win     â†’ $INGRESS_IP"
          echo "  api.shopping.voidspace.win â†’ $INGRESS_IP"
          echo ""
          echo "å¦‚æœ IP æ”¹è®Šï¼Œè«‹æ›´æ–° Cloudflare DNS è¨­å®š"
          echo "========================================="
      
      - name: é©—è­‰éƒ¨ç½²
        run: |
          echo "========================================="
          echo "éƒ¨ç½²å®Œæˆ"
          echo "========================================="
          kubectl get pods -l app=shoppingclient
          kubectl get deployment shoppingclient-deployment
          kubectl get service shoppingclient-service