# Shopping.Functions CI/CD Pipeline
# 功能：建置、測試、自動部署 Azure Functions

name: Shopping.Functions CI/CD

# 觸發條件：當 Functions 資料夾或此 workflow 檔案被修改時
on:
  push:
    branches:
      - master
      - price-tracking(Azure-Queue-+-Functions)
    paths:
      - 'shopping/Shopping.Functions/**'
      - '.github/workflows/shoppingfunctions-cicd.yml'
  
  workflow_dispatch:  # 允許手動觸發

# 環境變數
env:
  PROJECT_PATH: shopping/Shopping.Functions
  AZURE_FUNCTIONAPP_NAME: shopping-functions  # 你的 Function App 名稱
  DOTNET_VERSION: '8.0.x'

jobs:
  # Job 1: 建置與測試
  build-and-test:
    name: 建置與測試
    runs-on: ubuntu-latest
    
    steps:
      - name: 檢出程式碼
        uses: actions/checkout@v4
      
      - name: 設定 .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: 還原套件
        run: dotnet restore ${{ env.PROJECT_PATH }}
      
      - name: 建置專案
        run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore
      
      - name: 發行專案
        run: dotnet publish ${{ env.PROJECT_PATH }} --configuration Release --output ./output --no-build
      
      - name: 上傳 Artifact（供部署使用）
        uses: actions/upload-artifact@v4
        with:
          name: functions-app
          path: ./output

  # Job 2: 部署到 Azure Functions
  deploy-to-azure:
    name: 部署到 Azure Functions
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: 下載 Artifact
        uses: actions/download-artifact@v4
        with:
          name: functions-app
          path: ./output
      
      - name: 登入 Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: 部署到 Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: ./output
          respect-funcignore: true
      
      - name: 驗證部署
        run: |
          echo "========================================="
          echo "✅ Azure Functions 部署完成"
          echo "========================================="
          echo "Function App: ${{ env.AZURE_FUNCTIONAPP_NAME }}"
          echo "部署時間: $(date)"
          echo ""
          echo "Functions:"
          echo "  - PriceChangeProcessor (Queue Trigger)"
          echo "  - NotificationSender (Queue Trigger)"
          echo "========================================="